/**
 * Tabs Block - Save Component
 *
 * Renders the frontend HTML structure with proper ARIA attributes for tabs.
 * Applies theme class names and only outputs inline CSS for explicit customizations.
 * Uses hybrid Tier 2 CSS approach for optimal performance.
 * Supports horizontal/vertical orientation and responsive fallback.
 *
 * @package
 * @since 1.0.0
 */

import { useBlockProps, InnerBlocks } from '@wordpress/block-editor';
import { getAllEffectiveValues } from '@shared';

/**
 * Tabs Save Component
 *
 * @param {Object}   props            Block props
 * @param {Object}   props.attributes Block attributes
 * @param {Array}    props.innerBlocks Array of inner block objects
 * @return {JSX.Element} Save component
 */
export default function Save( { attributes } ) {
	// Get CSS defaults (will be available via wp_localize_script in frontend)
	const cssDefaults = window.tabsDefaults || {};

	// Get effective values for display purposes (icon rendering, etc.)
	const effectiveValues = getAllEffectiveValues(
		attributes,
		{}, // Themes are resolved server-side via CSS classes
		cssDefaults,
		'tabs'
	);

	/**
	 * Build inline CSS variables ONLY for explicit customizations (Tier 3)
	 * Theme values (Tier 2) are applied via CSS classes generated by PHP
	 * CSS defaults (Tier 1) are in the stylesheet
	 */
	const getCustomizationStyles = () => {
		const styles = {};

		// Helper to add style if attribute is explicitly defined
		const addIfDefined = ( attrName, cssVar, formatter ) => {
			if ( attributes[ attrName ] !== null && attributes[ attrName ] !== undefined ) {
				styles[ cssVar ] = formatter ? formatter( attributes[ attrName ] ) : attributes[ attrName ];
			}
		};

		// Tab Button Colors
		addIfDefined( 'tabButtonColor', '--tab-button-color' );
		addIfDefined( 'tabButtonBackgroundColor', '--tab-button-bg' );
		addIfDefined( 'tabButtonHoverColor', '--tab-button-hover-color' );
		addIfDefined( 'tabButtonHoverBackgroundColor', '--tab-button-hover-bg' );
		addIfDefined( 'tabButtonActiveColor', '--tab-button-active-color' );
		addIfDefined( 'tabButtonActiveBackgroundColor', '--tab-button-active-bg' );
		addIfDefined( 'tabButtonActiveBorderColor', '--tab-button-active-border-color' );
		addIfDefined( 'tabButtonActiveBorderBottomColor', '--tab-button-active-border-bottom-color' );

		// Tab Button Border and Shadow (buttonBorders group)
		addIfDefined( 'buttonBorderColor', '--tabs-border-button-color' );
		addIfDefined( 'buttonBorderWidth', '--tabs-border-button-width', ( val ) => `${ val }px` );
		addIfDefined( 'buttonBorderStyle', '--tabs-border-button-style' );
		addIfDefined( 'buttonShadow', '--tabs-border-button-shadow' );
		addIfDefined( 'buttonShadowHover', '--tabs-border-button-shadow-hover' );

		// Tab Button Border Radius
		if ( attributes.buttonBorderRadius ) {
			const br = attributes.buttonBorderRadius;
			styles[ '--tabs-border-button-radius' ] = `${ br.topLeft }px ${ br.topRight }px ${ br.bottomRight }px ${ br.bottomLeft }px`;
		}

		// Tab Button Typography
		addIfDefined( 'tabButtonFontSize', '--tab-button-font-size', ( val ) => `${ val }px` );
		addIfDefined( 'tabButtonFontWeight', '--tab-button-font-weight' );
		addIfDefined( 'tabButtonFontStyle', '--tab-button-font-style' );
		addIfDefined( 'tabButtonTextTransform', '--tab-button-text-transform' );
		addIfDefined( 'tabButtonTextDecoration', '--tab-button-text-decoration' );
		addIfDefined( 'tabButtonTextAlign', '--tab-button-text-align' );

		// Tab Button Padding
		if ( attributes.tabButtonPadding ) {
			const p = attributes.tabButtonPadding;
			styles[ '--tab-button-padding' ] = `${ p.top }px ${ p.right }px ${ p.bottom }px ${ p.left }px`;
		}

		// Tab List Colors and Border
		addIfDefined( 'tabListBackgroundColor', '--tab-list-bg' );

		// Block-level Borders (blockBorders group)
		addIfDefined( 'blockBorderColor', '--tabs-border-color' );
		addIfDefined( 'blockBorderWidth', '--tabs-border-width', ( val ) => `${ val }px` );
		addIfDefined( 'blockBorderStyle', '--tabs-border-style' );
		addIfDefined( 'blockShadow', '--tabs-border-shadow' );
		addIfDefined( 'blockShadowHover', '--tabs-border-shadow-hover' );

		// Block Border Radius
		if ( attributes.blockBorderRadius ) {
			const br = attributes.blockBorderRadius;
			styles[ '--tabs-border-radius' ] = `${ br.topLeft }px ${ br.topRight }px ${ br.bottomRight }px ${ br.bottomLeft }px`;
		}

		// Navigation Borders (navigationBorders group)
		addIfDefined( 'navBorderColor', '--tabs-border-nav-color' );
		addIfDefined( 'navBorderWidth', '--tabs-border-nav-width', ( val ) => `${ val }px` );
		addIfDefined( 'navBorderStyle', '--tabs-border-nav-style' );

		// Navigation Border Radius
		if ( attributes.navBorderRadius ) {
			const br = attributes.navBorderRadius;
			styles[ '--tabs-border-nav-radius' ] = `${ br.topLeft }px ${ br.topRight }px ${ br.bottomRight }px ${ br.bottomLeft }px`;
		}

		// Tab Panel Colors
		addIfDefined( 'panelColor', '--tab-panel-color' );
		addIfDefined( 'panelBackgroundColor', '--tab-panel-bg' );

		// Tab Panel Border and Shadow (contentBorders group)
		addIfDefined( 'contentBorderColor', '--tabs-border-content-color' );
		addIfDefined( 'contentBorderWidth', '--tabs-border-content-width', ( val ) => `${ val }px` );
		addIfDefined( 'contentBorderStyle', '--tabs-border-content-style' );
		addIfDefined( 'contentShadow', '--tabs-border-content-shadow' );

		// Tab Panel Border Radius
		if ( attributes.contentBorderRadius ) {
			const br = attributes.contentBorderRadius;
			styles[ '--tabs-border-content-radius' ] = `${ br.topLeft }px ${ br.topRight }px ${ br.bottomRight }px ${ br.bottomLeft }px`;
		}



		// Divider (dividerBorders group)
		addIfDefined( 'dividerBorderColor', '--tabs-border-divider-color' );
		addIfDefined( 'dividerBorderWidth', '--tabs-border-divider-width', ( val ) => `${ val }px` );
		addIfDefined( 'dividerBorderStyle', '--tabs-border-divider-style' );

		// Icon
		addIfDefined( 'iconColor', '--tab-icon-color' );
		addIfDefined( 'iconSize', '--tab-icon-size', ( val ) => `${ val }px` );
		addIfDefined( 'iconRotation', '--tab-icon-rotation', ( val ) => `${ val }deg` );


		return styles;
	};

	const customizationStyles = getCustomizationStyles();

	/**
	 * Render icon based on settings
	 * Supports both character and image icons
	 * Can use rotation or separate open/closed icons
	 */
	const renderIcon = () => {
		if ( ! effectiveValues.showIcon ) {
			return null;
		}

		const iconClosed = effectiveValues.iconTypeClosed || 'â–¾';
		const iconOpen = effectiveValues.iconTypeOpen;
		const isImage = iconClosed.startsWith( 'http' );

		if ( isImage ) {
			return (
				<img
					src={ iconClosed }
					alt=""
					aria-hidden="true"
					className="tab-icon tab-icon-image"
					data-icon-closed={ iconClosed }
					data-icon-open={ iconOpen !== 'none' ? iconOpen : iconClosed }
				/>
			);
		}

		return (
			<span
				className="tab-icon"
				aria-hidden="true"
				data-icon-closed={ iconClosed }
				data-icon-open={ iconOpen !== 'none' ? iconOpen : iconClosed }
			>
				{ iconClosed }
			</span>
		);
	};

	// Build class names - add theme class if using a theme
	const classNames = [ 'wp-block-tabs', 'sammu-blocks' ];
	if ( attributes.currentTheme ) {
		// Sanitize theme ID for CSS class (alphanumeric and hyphens only)
		const safeThemeId = attributes.currentTheme.replace( /[^a-zA-Z0-9\-]/g, '' );
		classNames.push( `tabs-theme-${ safeThemeId }` );
	}
	if ( attributes.enableResponsiveFallback ) {
		classNames.push( 'responsive-accordion' );
	}

	const blockProps = useBlockProps.save( {
		className: classNames.join( ' ' ),
		'data-orientation': attributes.orientation || 'horizontal',
		'data-activation-mode': attributes.activationMode || 'auto',
		'data-breakpoint': attributes.responsiveBreakpoint || 768,
		'data-responsive-fallback': attributes.enableResponsiveFallback || true,
		// Only add inline styles if there are customizations
		...( Object.keys( customizationStyles ).length > 0 && { style: customizationStyles } ),
	} );

	return (
		<div { ...blockProps }>
			{ /* Tab List - Tab Buttons */ }
			<div
				className="tabs-list"
				role="tablist"
				aria-orientation={ attributes.orientation || 'horizontal' }
				data-current-tab={ attributes.currentTab || 0 }
			></div>

			{ /* Tab Panels */ }
			<div className="tabs-panels">
				<InnerBlocks.Content />
			</div>
		</div>
	);
}
