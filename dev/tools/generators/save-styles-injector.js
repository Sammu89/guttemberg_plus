/**
 * Save.js Style Injector Generator
 *
 * Auto-generates the getCustomizationStyles() function code for save.js files.
 * This function maps block customizations to CSS variables for inline style output.
 *
 * Generated code:
 * - Iterates through customizations attribute
 * - Maps each customization to its CSS variable (from schema cssVar field)
 * - Applies proper units (from schema unit field)
 * - Handles complex object types (borderRadius, padding)
 * - Returns style object ready for React inline styles
 *
 * This ensures save.js always uses correct CSS variable names from schema,
 * preventing manual mapping errors and keeping code DRY.
 *
 * @package
 * @since 1.0.0
 */

/**
 * Generate the getCustomizationStyles function code for a specific block
 *
 * @param {Object} schema    - The block's JSON schema
 * @param {string} blockType - Block type identifier (accordion, tabs, toc)
 * @return {string} JavaScript code for the getCustomizationStyles function
 */
function generateSaveStyleMapping( schema, blockType ) {
	// Collect all themeable attributes with CSS variables
	const themeableAttrs = [];

	Object.entries( schema.attributes ).forEach( ( [ attrName, attr ] ) => {
		if ( attr.themeable && attr.cssVar ) {
			themeableAttrs.push( {
				attrName,
				cssVar: attr.cssVar,
				type: attr.type,
				unit: attr.unit || null,
			} );
		}
	} );

	// Start building the function code
	const code = `	/**
	 * Build inline CSS variables ONLY for explicit customizations (Tier 3)
	 * Theme values (Tier 2) are applied via CSS classes generated by PHP
	 * CSS defaults (Tier 1) are in the stylesheet
	 *
	 * The \`customizations\` attribute contains ONLY deltas from expected values
	 * (calculated in edit.js by comparing attributes to defaults + theme)
	 *
	 * Uses auto-generated mappings from schema (single source of truth)
	 */
	const getCustomizationStyles = () => {
		const styles = {};

		// Get customizations (deltas from expected values, calculated in edit.js)
		const customizations = attributes.customizations || {};

		// Process each customization using schema-generated mappings
		Object.entries( customizations ).forEach( ( [ attrName, value ] ) => {
			if ( value === null || value === undefined ) {
				return;
			}

			// Get CSS variable name from generated mappings
			const cssVar = getCssVarName( attrName, '${ blockType }' );
			if ( ! cssVar ) {
				return; // Attribute not mapped to a CSS variable
			}

			// Format value with proper unit from generated mappings
			const formattedValue = formatCssValue( attrName, value, '${ blockType }' );
			if ( formattedValue !== null ) {
				styles[ cssVar ] = formattedValue;
			}
		} );

		return styles;
	};`;

	return code;
}

/**
 * Generate complete documentation for the save.js injection
 *
 * @param {Object} schema    - The block's JSON schema
 * @param {string} blockType - Block type identifier
 * @return {Object} Object with generated code and metadata
 */
function generateSaveStyleInjection( schema, blockType ) {
	const blockName = schema.blockName || blockType;
	const code = generateSaveStyleMapping( schema, blockType );

	// Count themeable attributes for documentation
	const themeableCount = Object.values( schema.attributes ).filter(
		( attr ) => attr.themeable && attr.cssVar
	).length;

	return {
		blockType,
		blockName,
		themeableAttributeCount: themeableCount,
		generatedCode: code,
		usage: {
			imports: [
				"import { getCssVarName, formatCssValue } from '@shared/config/css-var-mappings-generated';",
			],
			placement: 'Inside save.js component, before the component returns JSX',
			applyStyles: 'const customizationStyles = getCustomizationStyles();',
			outputToJSX:
				'...( Object.keys( customizationStyles ).length > 0 && { style: customizationStyles } )',
		},
	};
}

/**
 * Generate sample output for demonstration
 *
 * @param {Object} schema    - The block's JSON schema
 * @param {string} blockType - Block type identifier
 * @return {string} Formatted example output
 */
function generateSample( schema, blockType ) {
	const result = generateSaveStyleInjection( schema, blockType );

	const output = `
================================================================================
SAVE.JS STYLE MAPPING GENERATOR - ${ result.blockName.toUpperCase() } BLOCK
================================================================================

Block Type: ${ result.blockType }
Themeable Attributes with CSS Variables: ${ result.themeableAttributeCount }

REQUIRED IMPORTS:
${ result.usage.imports.join( '\n' ) }

GENERATED FUNCTION CODE:
--------------------------------------------------------------------------------
${ result.generatedCode }

USAGE IN SAVE.JS:
--------------------------------------------------------------------------------
1. Place the generated function inside your save component (after effectiveValues)

2. Call the function:
   ${ result.usage.applyStyles }

3. Apply to JSX element:
   const blockProps = useBlockProps.save( {
       className: classNames.join( ' ' ),
       ${ result.usage.outputToJSX }
   } );

EXAMPLE CUSTOMIZATIONS INPUT:
--------------------------------------------------------------------------------
attributes.customizations = {
  titleColor: '#ff0000',
  borderWidth: 2,
  borderRadius: { topLeft: 8, topRight: 8, bottomRight: 8, bottomLeft: 8 }
}

EXAMPLE GENERATED OUTPUT:
--------------------------------------------------------------------------------
{
  '--${ blockType }-title-color': '#ff0000',
  '--${ blockType }-border-width': '2px',
  '--${ blockType }-border-radius': '8px 8px 8px 8px'
}

HOW IT WORKS:
--------------------------------------------------------------------------------
1. Reads customizations from attributes.customizations (delta values only)
2. For each customization, uses getCssVarName() to get CSS variable name
3. Uses formatCssValue() to apply proper units and format complex objects
4. Returns style object ready for React inline styles prop
5. CSS variables override Tier 2 (theme) and Tier 1 (defaults) via cascade

WHY THIS APPROACH:
--------------------------------------------------------------------------------
✓ Single source of truth: Schema defines CSS variable names
✓ No manual mapping: getCssVarName() and formatCssValue() read from schema
✓ Type-safe: Schema validation ensures correct types and units
✓ DRY: Same mapping logic used across all blocks
✓ Maintainable: Change schema, rebuild, done - no manual edits

================================================================================
`;

	return output;
}

module.exports = {
	generateSaveStyleMapping,
	generateSaveStyleInjection,
	generateSample,
};
