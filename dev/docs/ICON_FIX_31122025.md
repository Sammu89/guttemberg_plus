# Icon Panel UI Implementation Plan
**Date:** December 31, 2025

## Problem Summary

The icon-panel macro expansion in schema-compiler works perfectly, generating all 13 attributes correctly with proper defaults, themeable flags, and conditional rendering metadata. The theme system saves them correctly, and frontend rendering works. **The only issue is in the editor sidebar UI** - the schema-driven rendering system doesn't display the icon controls properly.

### Current Issues

1. **IconPicker renders as plain TextControl** - ControlRenderer line 612 has an IconPicker case but renders `<TextControl>` instead of the actual `<IconPicker>` component
2. **Icon position limited** - IconPositionControl doesn't read allowed positions from schema (hardcoded to left/right)
3. **Conditional rendering not working** - Schema has `conditionalRender` field but ControlRenderer only supports `showWhen`/`disabledWhen`
4. **Missing UI toggles** - No "Show Icon" or "Different icons for open/close" toggles in the UI
5. **IconPanel not integrated** - Standalone component not part of schema-driven rendering

## Solution Architecture

### Approach: Simplify Schema + Fix Rendering

We'll simplify the icon-panel schema syntax AND fix the rendering layer:

1. **Simplify icon-panel schema syntax** - Remove redundant fields, make expander smarter
2. **Fix IconPicker rendering** in ControlRenderer
3. **Add showIcon and useDifferentIcons toggles** via schema-compiler macro enhancement
4. **Implement conditionalRender support** in ControlRenderer
5. **Update IconPositionControl** to read allowed positions from schema

### Schema Simplifications

**Remove these redundant fields:**
- `label` - Can derive from attribute name or use default "Icon"
- `description` - Can auto-generate or make optional
- `group` - Always "icon" for icon-panel
- `structureElement` - Redundant with `appliesToElement`
- `positioningProfile` - Infer from blockType (accordion schema → "accordion" profile)
- `responsive` - Expander knows size/maxSize/offsetX/offsetY are always responsive
- `active: null` - Make implicit (if not provided, inherit from inactive)

**Rename for clarity:**
- `appliesTo` → `appliesToElement`
- `kind` → `icon-type` (in default values)

**Result:** Cleaner, more maintainable schemas with smarter macro expander

---

## Critical Files

### Files to Modify

1. **Schema files** - Simplify icon-panel syntax
   - `schemas/accordion.json`
   - `schemas/tabs.json`
   - `schemas/toc.json`

2. **Build tools** - Make expander smarter
   - `build-tools/schema-compiler.js` - Enhance icon-panel macro expander

3. **Components** - Fix rendering
   - `shared/src/components/ControlRenderer.js` - Fix IconPicker case, add conditionalRender support
   - `shared/src/components/controls/IconPositionControl.js` - Read allowed positions from schema

---

## Implementation Steps

### Step 0: Simplify Icon-Panel Schema Syntax

**Location:** Schema JSON files (`schemas/accordion.json`, `schemas/tabs.json`, `schemas/toc.json`)

**Old syntax:**
```json
"titleIcon": {
  "type": "icon-panel",
  "label": "Title Icon",
  "description": "Expand/collapse icon for accordion header",
  "order": 2,
  "group": "icon",
  "cssVar": "accordion-icon",
  "appliesTo": "icon",
  "structureElement": "icon",
  "positioningProfile": "accordion",
  "themeable": true,
  "outputsCSS": false,
  "responsive": ["size", "maxSize", "offsetX", "offsetY"],
  "default": {
    "position": "right",
    "rotation": "180deg",
    "inactive": {
      "source": { "kind": "char", "value": "▾" },
      "color": "#333333",
      "size": "16px",
      "maxSize": "24px",
      "offsetX": "0px",
      "offsetY": "0px"
    },
    "active": null
  }
}
```

**New simplified syntax:**
```json
"titleIcon": {
  "type": "icon-panel",
  "order": 2,
  "cssVar": "accordion-icon",
  "appliesToElement": "icon",
  "themeable": true,
  "outputsCSS": false,
  "default": {
    "position": "right",
    "rotation": "180deg",
    "inactive": {
      "source": { "icon-type": "char", "value": "▾" },
      "color": "#333333",
      "size": "16px",
      "maxSize": "24px",
      "offsetX": "0px",
      "offsetY": "0px"
    }
  }
}
```

**What was removed and why:**
- ❌ `label` - Expander generates from attribute name: "titleIcon" → "Title Icon"
- ❌ `description` - Auto-generated: "Icon settings for accordion"
- ❌ `group` - Always "icon" for icon-panel type
- ❌ `structureElement` - Same as `appliesToElement`
- ❌ `positioningProfile` - Inferred from blockType (accordion/tabs/toc)
- ❌ `responsive` - Expander knows size/maxSize/offsetX/offsetY are responsive
- ❌ `active: null` - If omitted, means inherit from inactive (implicit)
- ✏️ `appliesTo` → `appliesToElement` - More descriptive name
- ✏️ `kind` → `icon-type` - More descriptive name in source objects

---

### Step 1: Enhance Icon-Panel Macro Expander (schema-compiler.js)

**Location:** Lines 267-465, `expandIconPanelMacro()` function

**Changes:**

**1. Make expander smarter - infer missing fields:**

```javascript
function expandIconPanelMacro(macroName, macro, blockType) {
  const attributes = {};

  // Infer missing fields with smart defaults
  const group = 'icon'; // Always 'icon' for icon-panel
  const label = macro.label || macroName.replace(/([A-Z])/g, ' $1').trim(); // "titleIcon" → "Title Icon"
  const description = macro.description || `Icon settings for ${blockType}`;
  const positioningProfile = blockType; // Always infer from blockType
  const appliesToElement = macro.appliesToElement || 'icon';
  const structureElement = appliesToElement; // Same as appliesToElement

  // Responsive attributes are always the same for icons
  const responsiveAttrs = ['size', 'maxSize', 'offsetX', 'offsetY'];

  // If active state not provided, it means inherit from inactive (null)
  const defaults = macro.default || {};
  const inactiveDefaults = defaults.inactive || {};
  const activeDefaults = defaults.active !== undefined ? defaults.active : null;

  // ... rest of expander logic
}
```

**2. Handle icon-type (convert to kind for IconPicker):**

```javascript
// When processing source attributes
const sourceDefault = stateDefaults?.source || { 'icon-type': 'char', value: '▾' };

// Convert icon-type to kind for IconPicker component compatibility
const normalizedSource = {
  kind: sourceDefault['icon-type'] || 'char',
  value: sourceDefault.value || '▾'
};
```

**3. Add two new toggle attributes at the start of the expansion:**

```javascript
// 1. showIcon (boolean toggle)
attributes['showIcon'] = {
  type: 'boolean',
  default: true,
  control: 'ToggleControl',
  themeable: true,
  responsive: false,
  outputsCSS: false,
  group: 'icon',
  order: (macro.order || 0),
  label: 'Show Icon',
  description: 'Display icon in the block'
};

// 2. useDifferentIcons (boolean toggle)
attributes['useDifferentIcons'] = {
  type: 'boolean',
  default: false,
  control: 'ToggleControl',
  themeable: true,
  responsive: false,
  outputsCSS: false,
  group: 'icon',
  order: (macro.order || 0) + 0.05,
  label: 'Different Icons for Open/Close',
  description: 'Use different icons for active and inactive states',
  showWhen: {
    showIcon: [true]
  }
};
```

**4. Update all other attributes to have showWhen:**

```javascript
// iconPosition
showWhen: { showIcon: [true] }

// iconRotation
showWhen: {
  showIcon: [true],
  useDifferentIcons: [false]
}

// All inactive attributes
showWhen: { showIcon: [true] }

// All active attributes
showWhen: {
  showIcon: [true],
  useDifferentIcons: [true]
}
```

**5. Adjust order offsets:**
- showIcon: `order` (e.g., 2.0)
- useDifferentIcons: `order + 0.05` (e.g., 2.05)
- iconPosition: `order + 0.1` (e.g., 2.1)
- iconRotation: `order + 0.15` (e.g., 2.15)
- Inactive attributes: `order + 0.2 + [0, 0.01, 0.02...]` (e.g., 2.2, 2.21...)
- Active attributes: `order + 0.3 + [0, 0.01, 0.02...]` (e.g., 2.3, 2.31...)

---

### Step 2: Update Schema JSON Files

**Apply the simplified syntax to all three blocks:**

1. `schemas/accordion.json` - Update titleIcon definition
2. `schemas/tabs.json` - Update tabIcon definition
3. `schemas/toc.json` - Update tocIcon definition

**Changes for each:**
- Remove: `label`, `description`, `group`, `structureElement`, `positioningProfile`, `responsive`
- Rename: `appliesTo` → `appliesToElement`
- Update source objects: `kind` → `icon-type`
- Remove: `active: null` (implicit if omitted)

---

### Step 3: Fix IconPicker Rendering (ControlRenderer.js)

**Location:** Line 612-625, IconPicker case

**Change from:**
```javascript
case 'IconPicker': {
  const iconHelp = helpText || "Use a character, Unicode code, or image URL...";
  return (
    <TextControl
      // ...
    />
  );
}
```

**Change to:**
```javascript
case 'IconPicker': {
  const { IconPicker } = require('./controls');
  return (
    <IconPicker
      label={renderLabel(finalLabel)}
      value={effectiveValue ?? defaultValue ?? { kind: 'char', value: '▾' }}
      onChange={handleChange}
      help={helpText}
    />
  );
}
```

---

### Step 4: Add conditionalRender Support (ControlRenderer.js)

**Location:** Lines 218-220, after showWhen check

**Add new section:**

```javascript
// Check conditionalRender (expression-based visibility)
if (attrConfig.conditionalRender) {
  const shouldShow = evaluateConditionalRender(
    attrConfig.conditionalRender,
    effectiveValues
  );
  if (!shouldShow) {
    return null;
  }
}
```

**Add helper function (before ControlRenderer component):**

```javascript
/**
 * Evaluate conditionalRender expression
 * Examples:
 *   "iconInactiveSource.kind !== 'image'"
 *   "iconActiveSource.kind === 'image'"
 *
 * @param {string} expression - JavaScript expression to evaluate
 * @param {Object} values - Effective attribute values
 * @returns {boolean} - Whether control should be shown
 */
function evaluateConditionalRender(expression, values) {
  try {
    // Create a safe evaluation context
    // Replace attribute references with actual values
    let safeExpression = expression;

    // Find all attribute references (e.g., iconInactiveSource.kind)
    const attrPattern = /(\w+(?:\.\w+)*)/g;
    const matches = expression.match(attrPattern);

    if (matches) {
      const evalContext = {};
      matches.forEach(match => {
        // Get nested value (e.g., iconInactiveSource.kind)
        const parts = match.split('.');
        let value = values;
        for (const part of parts) {
          value = value?.[part];
        }
        evalContext[match.replace(/\./g, '_')] = value;
        safeExpression = safeExpression.replace(
          new RegExp(match.replace(/\./g, '\\.'), 'g'),
          match.replace(/\./g, '_')
        );
      });

      // Evaluate with context
      const func = new Function(...Object.keys(evalContext), `return ${safeExpression}`);
      return func(...Object.values(evalContext));
    }

    return true; // Default to showing if can't parse
  } catch (error) {
    console.warn('Failed to evaluate conditionalRender:', expression, error);
    return true; // Default to showing on error
  }
}
```

---

### Step 5: Update IconPositionControl (IconPositionControl.js)

**Current issue:** Reads from shared-templates.json which only has left/right positions

**Solution:** Read allowed positions from control-config-generated.js (already exported by schema-compiler)

**Location:** `shared/src/components/controls/IconPositionControl.js`

**Changes:**

1. Import getControlConfig:
```javascript
import { getControlConfig } from '../../config/control-config-generated';
```

2. Add blockType prop to component:
```javascript
export function IconPositionControl({
  label = 'Icon Position',
  value,
  onChange,
  useAltIcons = true,
  blockType, // NEW PROP
}) {
```

3. Replace sharedTemplates usage with control-config:
```javascript
// OLD: const { iconPositions } = sharedTemplates;
// OLD: const positionOptions = iconPositions?.options || [...]

// NEW:
const config = blockType ? getControlConfig(blockType, 'iconPosition') : null;
const allowedPositions = config?.allowedPositions || ['left', 'right'];

// Create full position options including extreme positions
const ALL_POSITION_OPTIONS = [
  { name: 'Left', value: 'left' },
  { name: 'Right', value: 'right' },
  { name: 'Extreme Left', value: 'extreme-left' },
  { name: 'Extreme Right', value: 'extreme-right' },
];

const positionOptions = ALL_POSITION_OPTIONS.filter(opt =>
  allowedPositions.includes(opt.value)
);
```

4. Reuse existing icons for extreme positions (with labels):
```javascript
const AlternativePositionIcons = {
  left: <svg>...</svg>,
  right: <svg>...</svg>,
  'extreme-left': <svg>...</svg>,  // Same as left icon, distinguished by label
  'extreme-right': <svg>...</svg>, // Same as right icon, distinguished by label
};

const PositionIcons = {
  left: <svg>...</svg>,
  right: <svg>...</svg>,
  'extreme-left': <svg>...</svg>,  // Same as left icon, distinguished by label
  'extreme-right': <svg>...</svg>, // Same as right icon, distinguished by label
};
```

5. Update ControlRenderer to pass blockType:
```javascript
// In ControlRenderer.js, IconPositionControl case (line ~1020)
case 'IconPositionControl': {
  return (
    <IconPositionControl
      label={renderLabel(finalLabel)}
      value={effectiveValue ?? defaultValue ?? 'left'}
      onChange={handleChange}
      blockType={blockType} // ADD THIS LINE
    />
  );
}
```

---

### Step 6: Rebuild and Validate

**Commands:**
```bash
npm run schema:build  # Regenerate all files from schemas
npm run build         # Compile WordPress blocks
```

**Validation steps:**
1. Check `control-config-generated.js` includes allowedPositions for iconPosition
2. Verify accordion/TOC have 4 positions, tabs have 2
3. Test in WordPress editor:
   - Show Icon toggle appears and works
   - Different Icons toggle appears when Show Icon is on
   - IconPicker renders properly (not as text input)
   - Color/Size show only for character/library icons
   - Max Size shows only for image icons
   - Rotation shows only when useDifferentIcons is false
   - Active state controls show only when useDifferentIcons is true
   - All values save correctly to themes

---

## Testing Checklist

### Schema Compiler
- [ ] Two new attributes generated (showIcon, useDifferentIcons)
- [ ] All 13 icon attributes have correct showWhen rules
- [ ] allowedPositions exported to control-config-generated.js
- [ ] Order offsets adjusted correctly
- [ ] Label auto-generated from attribute name
- [ ] positioningProfile inferred from blockType
- [ ] icon-type converted to kind for IconPicker

### ControlRenderer
- [ ] IconPicker case renders actual IconPicker component
- [ ] conditionalRender evaluation works for icon kind checks
- [ ] No console errors when rendering icon controls
- [ ] blockType passed to IconPositionControl

### IconPositionControl
- [ ] Reads allowedPositions from control-config
- [ ] Accordion/TOC show 4 positions (left, right, extreme-left, extreme-right)
- [ ] Tabs show 2 positions (left, right)
- [ ] Extreme position icons display correctly

### Editor UI
- [ ] Show Icon toggle visible at top of Icon panel
- [ ] Different Icons toggle visible when Show Icon is on
- [ ] All controls hide when Show Icon is off
- [ ] Rotation visible only when Different Icons is off
- [ ] Active state controls visible only when Different Icons is on
- [ ] Color/Size visible only for character/library icons
- [ ] Max Size visible only for image icons
- [ ] IconPicker shows full UI (tabs, library, media picker)

### Theme System
- [ ] All 15 attributes (13 + 2 toggles) save to themes
- [ ] Applying theme restores all icon settings
- [ ] Block-level customizations override theme values
- [ ] Delta calculator properly handles new toggle attributes

---

## Success Criteria

1. **Simplified schema syntax** - All redundant fields removed, cleaner definitions
2. **Smart macro expander** - Infers group, label, description, positioningProfile
3. **Full UI functionality** - All 5 desired UI elements working (Show Icon toggle, position dropdown, rotation slider, IconPicker, Different Icons toggle)
4. **Proper conditional rendering** - Color/size/maxSize show/hide based on icon type
5. **Theme compatibility** - All settings save to themes and apply correctly
6. **Block-specific positioning** - Accordion/TOC get 4 positions, tabs get 2

---

## Implementation Notes

### Key Design Decisions

1. **Schema simplification** - Move intelligence from schema files into expander logic
2. **No backwards compatibility** - Clean break, simpler implementation
3. **icon-type normalization** - Schema uses `icon-type`, expander converts to `kind` for IconPicker
4. **Implicit active inheritance** - Omitting `active` means inherit from inactive
5. **Position inference** - blockType determines positioning profile automatically

### Expression Evaluation Security

The `evaluateConditionalRender()` function uses `new Function()` for expression evaluation. This is safe in this context because:
- Expressions come from schema files (trusted source)
- Only attribute references are evaluated (no user input)
- Errors default to showing controls (fail-safe)

---

## Conclusion

This plan delivers a complete, intuitive Icon panel UI by:
1. Simplifying icon-panel schema syntax (remove 7 redundant fields)
2. Enhancing the macro expander with smart inference
3. Fixing IconPicker rendering in ControlRenderer
4. Adding expression-based conditional rendering support
5. Making IconPositionControl schema-aware

The result is cleaner schemas, less repetition, and a fully functional editor UI with proper conditional controls and theme support.
