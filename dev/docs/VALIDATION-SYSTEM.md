# Validation System for Auto-Generated Code

## Overview

This document explains the comprehensive validation system that ensures all schema attributes and structure elements are properly synchronized between:
- Schema JSON files (`schemas/*.json`)
- Structure mapping files (`schemas/*-structure-mapping-autogenerated.json`)
- Generated code (`blocks/*/src/save.js` and `blocks/*/src/edit.js`)

## Why Validation is Critical

**Without validation, you can have:**
- âŒ Attributes defined in schema but never used (orphaned)
- âŒ Code accessing attributes that don't exist (runtime errors)
- âŒ Structure elements not rendered (missing UI)
- âŒ Inconsistencies between save.js and edit.js (save/load bugs)
- âŒ Missing variations/conditionals (broken features)

**With validation, you get:**
- âœ… Guaranteed schema â†” code sync
- âœ… Early detection of missing variables
- âœ… Confidence that all blocks will save/load correctly
- âœ… Prevention of runtime errors

---

## Validation Types

### 1. Schema â†” Code Sync Validator
**File:** `build-tools/validators/validate-schema-code-sync.js`

**Validates:**
- âœ“ All attributes accessed in code exist in schema
- âœ“ All schema attributes are used somewhere (no orphans)
- âœ“ Critical attributes (currentTheme, customizations) exist in both files
- âœ“ Consistency between save.js and edit.js

**Example Error:**
```
âŒ save.js accesses "attributes.iconPosition" but it's not defined in schema!
```

**How to Fix:**
1. Add the attribute to `schemas/accordion.json`
2. Or remove the code accessing it

---

### 2. Generated Code Completeness Validator
**File:** `build-tools/validators/validate-generated-code-completeness.js`

**Validates:**
- âœ“ All structure elements appear in generated code
- âœ“ All variations (iconPosition, headingLevel) are handled
- âœ“ Correct mode-specific wrappers (RichText vs RichText.Content)
- âœ“ All conditional branches exist
- âœ“ Attributes referenced in structure are accessed

**Example Errors:**
```
âŒ Element "titleWrapper" from structure mapping NOT found in generated save.js code
âŒ Element "titleText" uses <RichText> instead of <RichText.Content> in save.js
```

**How to Fix:**
1. Check structure-jsx-generator.js handles the element
2. Ensure element ID matches naming conventions
3. Regenerate code with `npm run schema:build`

---

## Running Validators

### During Build (Recommended)
```bash
npm run prebuild  # Runs validators with --warn-only
npm run build     # Full build with validation
```

### Standalone
```bash
# Run all validations
npm run validate:sync

# Run just schema-code sync
node build-tools/validators/validate-schema-code-sync.js

# Run just generated code completeness
node build-tools/validators/validate-generated-code-completeness.js
```

---

## Understanding Validator Output

### âœ… Success
```
âœ… accordion: All attributes synced correctly
âœ… save.js: All elements and attributes complete
âœ… ALL VALIDATIONS PASSED
```

### âš ï¸ Warnings (Non-Blocking)
```
âš ï¸ Attribute "animationType" used in save.js but NOT in edit.js (inconsistency!)
âš ï¸ Attribute "blockId" defined in schema but NEVER used (orphaned attribute)
```

**Action:** Review warnings - they may indicate:
- Intentional differences (some attrs are save-only or edit-only)
- Future attributes not yet implemented
- Deprecated attributes that should be removed

### âŒ Errors (Blocking)
```
âŒ save.js accesses "attributes.iconPosition" but it's not defined in schema!
âŒ CRITICAL: "customizations" missing from save.js!
âŒ Element "titleWrapper" NOT found in generated save.js code
```

**Action:** MUST FIX - these will cause runtime bugs!

---

## Common Issues and Solutions

### Issue 1: "Attribute accessed but not in schema"

**Cause:** Code uses `attributes.foo` but `foo` doesn't exist in schema

**Fix:**
```json
// schemas/accordion.json
{
  "attributes": {
    "foo": {
      "type": "string",
      "default": "",
      "themeable": true
    }
  }
}
```

---

### Issue 2: "Element not found in generated code"

**Cause:** Structure mapping defines element but generator doesn't render it

**Check:**
1. Element ID naming convention matches (camelCase or contains specific suffix)
2. Element is in the correct section (RENDER-TITLE vs BLOCK-CONTENT)
3. Generator has pattern for this block type

**Fix:**
```javascript
// build-tools/generators/structure-jsx-generator.js
// Add element rendering logic for new element types
```

---

### Issue 3: "Orphaned attribute" Warning

**Cause:** Attribute exists in schema but never used in code

**Options:**
1. **If intended for future use:** Keep it (warning is acceptable)
2. **If CSS-only:** Document in schema with `"usage": "css-only"`
3. **If deprecated:** Remove from schema

---

### Issue 4: "Inconsistency between save.js and edit.js"

**Cause:** Attribute used in one file but not the other

**Investigate:**
- Is this intentional? (some attributes are editor-only or frontend-only)
- Should both files use it?

**Common intentional differences:**
- `animationDuration` - edit.js only (preview)
- `data-animation-type` - save.js only (frontend)

---

## Attribute Categories

### Critical Attributes (MUST be in both files)
- `currentTheme` - theme system
- `customizations` - user customizations
- Block-specific IDs (`accordionId`, `tabsId`, `tocId`)

### Themeable Attributes (should be in both)
Most attributes with `"themeable": true` should appear in both save.js and edit.js via `effectiveValues`.

### Edit-Only Attributes
- Inspector panel states
- Editor UI preferences
- Responsive device state

### Save-Only Attributes
- SSR data attributes
- Frontend-specific flags

---

## Validation Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edit Schema or Structure Mapping          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  npm run schema:build                       â”‚
â”‚  (Regenerates code between markers)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Validators Run Automatically               â”‚
â”‚  1. validate-schema-code-sync.js            â”‚
â”‚  2. validate-generated-code-completeness.js â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚
          â–¼                 â–¼
    âœ… PASS          âŒ FAIL
          â”‚                 â”‚
          â”‚                 â–¼
          â”‚         Fix Issues
          â”‚                 â”‚
          â”‚                 â–¼
          â”‚         Re-run Build
          â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            âœ… Safe to Use
```

---

## Adding Validation for New Blocks

When adding a new block:

1. **Add structure mapping:**
   ```
   schemas/newblock-structure-mapping-autogenerated.json
   ```

2. **Add AUTO-GENERATED markers:**
   ```javascript
   // blocks/newblock/src/save.js
   /* ========== AUTO-GENERATED-RENDER-TITLE-START ========== */
   /* ========== AUTO-GENERATED-RENDER-TITLE-END ========== */
   ```

3. **Add block to validators:**
   ```javascript
   // build-tools/validators/*.js
   const blocks = ['accordion', 'tabs', 'toc', 'newblock'];
   ```

4. **Run validation:**
   ```bash
   npm run validate:sync
   ```

---

## Best Practices

### DO:
- âœ… Run validators before every commit
- âœ… Fix all errors (don't ignore them)
- âœ… Review warnings - they often indicate real issues
- âœ… Keep schema as single source of truth
- âœ… Document CSS-only attributes

### DON'T:
- âŒ Skip validation ("it works locally")
- âŒ Add attributes without schema definition
- âŒ Access `attributes.foo` without checking if it exists
- âŒ Ignore "critical attribute missing" errors

---

## Troubleshooting

### Validator Shows False Positives

**Possible causes:**
1. Attribute accessed via `customizations.foo` instead of `attributes.foo`
2. Element name transformed (camelCase â†” kebab-case)
3. CSS-only attribute (no JS access needed)

**Solutions:**
1. Update validator regex patterns
2. Add attribute to skip list
3. Document as CSS-only in schema

### Build Fails on CI but Passes Locally

**Check:**
1. Did you commit generated files?
2. Are node modules synced?
3. Run `npm run schema:build` locally first

---

## Integration with CI/CD

Add to your CI pipeline:

```yaml
# .github/workflows/build.yml
- name: Validate Schema-Code Sync
  run: npm run validate:sync

- name: Build Blocks
  run: npm run build
```

This ensures broken code never reaches production!

---

## Summary

**The validation system prevents:**
- Runtime errors from missing attributes
- Save/load bugs from code inconsistencies
- Missing UI elements from incomplete generation
- Deployment of broken blocks

**Run validators:**
- âœ“ Before every commit
- âœ“ During build (automatic)
- âœ“ After schema changes
- âœ“ When adding new blocks

**Remember:** Validation is your safety net - don't skip it! ğŸ›¡ï¸
