# Fixes Applied - January 19, 2026

## Session Summary

Fixed critical issues with sidebar panel controls not rendering properly as unified controls with link/unlink functionality.

---

## Issues Fixed

### 1. Border Controls Showing as Individual Sliders ✅

**Problem:**
- Border width, color, and style showing as separate controls
- Should be unified panel with link/unlink button
- User reported seeing "BORDER WIDTH (TOP)" instead of unified "Border" control

**Root Cause:**
- `ControlRenderer.js` BorderPanel case checked for `order` field
- Comprehensive schema uses `renderControl` flag instead
- Only found first attribute per type (.find() instead of iterating all sides)
- Didn't parse string values with units properly

**Fix Applied:**
- Changed check from `attrConfig.order === undefined` to `attrConfig.renderControl !== true`
- Iterate all 4 sides explicitly instead of using `.find()`
- Parse string values with units: `"4px"` → `{ value: 4, unit: "px" }`
- Build unified value objects for width, color, style
- Update all 4 side attributes when user changes values

**Files Modified:**
- `shared/components/ControlRenderer.js` (lines ~1273-1420)

---

### 2. Border Radius Showing as 4 Separate Sliders ✅

**Problem:**
- 4 separate sliders: "Border Radius (top Left)", "Border Radius (top Right)", etc.
- Should be unified control with link/unlink for all 4 corners

**Root Cause:**
- `box.js` expander generated radius with `control: "SliderWithInput"`
- No unified control pattern applied

**Fix Applied:**
- Updated `box.js` to generate with `control: "RadiusControl"`
- Added `controlId: "${baseName}Radius"`
- Set `renderControl: true` on first corner only
- Created new `RadiusControl` case in ControlRenderer
- Finds all 4 corners by controlId
- Parses string values with units
- Uses existing `BorderRadiusControl` component

**Files Modified:**
- `schemas/parsers/expansors/box.js` (lines ~188-217)
- `shared/components/ControlRenderer.js` (lines ~1422-1485)

---

### 3. Padding/Margin Showing as Individual Sliders ✅

**Problem:**
- Title Padding showing as 4 separate sliders
- Content Padding showing as 4 separate sliders
- Block Margin showing as 4 separate sliders
- Should be unified controls with link/unlink

**Root Cause:**
- `box.js` expander generated padding/margin with `control: "SliderWithInput"`
- No unified control pattern applied

**Fix Applied:**
- Updated `box.js` to generate with `control: "SpacingControl"`
- Added `controlId: "${baseName}Padding"` and `"${baseName}Margin"`
- Set `renderControl: true` on first side only
- Created new `SpacingControl` case in ControlRenderer
- Auto-detects padding vs margin from cssProperty
- For margin: restricts to top/bottom only
- Updates all side attributes simultaneously

**Files Modified:**
- `schemas/parsers/expansors/box.js` (lines ~132-186)
- `shared/components/ControlRenderer.js` (lines ~1488-1562)

---

### 4. Typography Panel Error: "r.some is not a function" ✅

**Problem:**
- Clicking Typography panel caused JavaScript error
- `TypeError: r.some is not a function`
- Panel wouldn't open

**Root Cause:**
- `FormattingControl` case built attribute names using camelCase
- Comprehensive schema uses kebab-case
- Tried to read `titleTypographyFontWeight` but schema has `title-typography-font-weight`
- Returned undefined, then tried to call `.filter()` on non-array

**Fix Applied:**
- Changed attribute name pattern from `/Formatting$/` to `/-formatting$/i`
- Build kebab-case names: `${base}-font-weight` not `${base}FontWeight`
- Added array validation before `.filter()` calls
- Ensure formatting value is always an array

**Files Modified:**
- `shared/components/ControlRenderer.js` (lines ~1776-1821)

---

## Pattern Identified

**All issues stemmed from the same root causes:**

1. **Missing renderControl check** - Using `order` field instead of `renderControl: true`
2. **Wrong search pattern** - Using `.find()` instead of iterating all sides/corners
3. **No value parsing** - Not extracting numeric values from strings like `"4px"`
4. **camelCase vs kebab-case** - Schema uses kebab-case, code used camelCase
5. **Missing array validation** - Assuming values are arrays without checking

---

## Unified Control Pattern

All unified controls now follow this pattern:

### Schema (Generated by Expander)
```json
{
  "attribute-name-side-1": {
    "control": "UnifiedControlName",
    "controlId": "groupId",
    "renderControl": true,  // ← Only first has this
    "cssProperty": "css-property-side-1"
  },
  "attribute-name-side-2": {
    "control": "UnifiedControlName",
    "controlId": "groupId",  // ← Same controlId
    "renderControl": false,  // ← Don't render separately
    "cssProperty": "css-property-side-2"
  }
  // ... same for remaining sides
}
```

### ControlRenderer Handler
```javascript
case 'UnifiedControlName': {
  // 1. Only render if renderControl: true
  if (attrConfig.renderControl !== true) {
    return null;
  }

  // 2. Find all related attributes by controlId
  const controlId = attrConfig.controlId;
  const relatedAttrs = Object.entries(schema.attributes)
    .filter(([, attr]) =>
      attr.control === 'UnifiedControlName' &&
      attr.controlId === controlId
    );

  // 3. Build unified value object (parse units if needed)
  const unifiedValue = {};
  sides.forEach(side => {
    const attrName = sideAttrs[side]?.[0];
    const rawValue = effectiveValues?.[attrName] ?? defaultValue;
    // Parse: "4px" → 4
    unifiedValue[side] = parseNumericValue(rawValue);
  });
  unifiedValue.unit = extractUnit(firstValue);

  // 4. Handle change - update ALL related attributes
  const handleChange = (newValue) => {
    const updates = {};
    sides.forEach(side => {
      const attrName = sideAttrs[side]?.[0];
      // Add unit back: 4 → "4px"
      updates[attrName] = `${newValue[side]}${newValue.unit}`;
    });
    setAttributes(updates);
  };

  // 5. Render control
  return (
    <UnifiedControl
      value={unifiedValue}
      onChange={handleChange}
    />
  );
}
```

---

## Implemented Unified Controls

| Control | Combines | Component | Lines |
|---------|----------|-----------|-------|
| **BorderPanel** | 12 attrs (4 sides × 3: width, color, style) | `BorderPanel` | 1273-1420 |
| **RadiusControl** | 4 attrs (4 corners) | `BorderRadiusControl` | 1422-1485 |
| **SpacingControl** | 4 attrs (4 sides: padding or margin) | `SpacingControl` | 1488-1562 |

---

## Schema Build Process

After fixes:
```bash
npm run schema:build  # Regenerate comprehensive schemas
npm run build         # Compile WordPress blocks
```

Total attributes in accordion block:
- **Before:** Individual controls for each side (cluttered sidebar)
- **After:** Unified controls with link/unlink (clean, professional UI)

---

## Documentation Updates

### 1. schemas/README.md
Added comprehensive "Unified Controls Implementation" section:
- Overview of unified controls
- How they work (controlId + renderControl pattern)
- Implementation details for all 3 controls
- Step-by-step guide for adding new unified controls
- Common pitfalls with examples
- Debugging guide

### 2. docs/architecture/Sidebar_Panels.md
Created new 800+ line guide covering:
- Architecture flow (schema → orchestrator → renderer → UI)
- Schema structure reference
- Panel hierarchy (tabs → groups → subgroups → attributes)
- Control rendering logic
- Unified controls deep dive
- 7 detailed examples
- Troubleshooting section with solutions
- Best practices

### 3. docs/FIXES_2026-01-19.md
This document - session summary and reference guide

---

## Testing Checklist

After applying fixes, verify:

- [ ] Borders panel shows unified "Border" control with color/style/width
- [ ] Border can be linked (all sides same) or unlinked (per-side)
- [ ] Border Radius shows unified control with 4 corners
- [ ] Radius can be linked or unlinked
- [ ] Layout panel shows "Padding" (not 4 separate sliders)
- [ ] Layout panel shows "Content Padding" unified
- [ ] Layout panel shows "Block Margin" (top/bottom only)
- [ ] Typography panel opens without errors
- [ ] Typography formatting controls work correctly
- [ ] All panels respect theme values
- [ ] Changes save correctly to database
- [ ] Theme switching works without data loss

---

## Breaking Changes

None. All fixes are backward compatible:
- Existing block data structure unchanged
- Database schema unchanged
- Only UI rendering improved
- Saved values still use same format (`"4px"` strings)

---

## Future Improvements

Potential enhancements (not urgent):

1. **Add responsive support to unified controls**
   - BorderPanel with tablet/mobile overrides
   - Would require responsive toggle per side

2. **Color linking for borders**
   - Currently color can be per-side
   - Could add "all same color" quick action

3. **Margin all-sides option**
   - Currently restricted to top/bottom
   - Could add toggle to show left/right

4. **Visual border preview**
   - Live preview of border as you edit
   - Show all 4 sides visually

---

## Related Files

**Schema System:**
- `schemas/blocks/accordion.json` - Minimal schema (human-edited)
- `schemas/generated/accordion.json` - Comprehensive schema (auto-generated)
- `schemas/parsers/expansors/box.js` - Box panel expander
- `schemas/parsers/expansors/border.js` - Border panel expander

**UI Components:**
- `shared/components/ControlRenderer.js` - Main control renderer
- `shared/components/SchemaPanels.js` - Panel hierarchy renderer
- `shared/components/controls/full/BorderPanel.js` - Border control
- `shared/components/controls/full/BorderRadiusControl.js` - Radius control
- `shared/components/controls/full/SpacingControl.js` - Padding/margin control

**Build Tools:**
- `tools/build.js` - Main schema build orchestrator
- `schemas/parsers/main-orchestrator.js` - Schema expansion

---

## Lessons Learned

### For Future Development

1. **Always use kebab-case for attribute names**
   - Comprehensive schema is kebab-case
   - Never build camelCase attribute names

2. **Always validate array values**
   - Check `Array.isArray()` before `.filter()`, `.map()`, etc.
   - Provide fallback: `array || []`

3. **Check renderControl flag, not order**
   - Comprehensive schema uses `renderControl: true`
   - `order` field is for standalone attributes only

4. **Parse string values with units**
   - Schema stores: `"4px"`
   - Controls need: `4` (number)
   - Always extract numeric value and unit

5. **Update ALL related attributes**
   - Unified controls must update every related attribute
   - Use loops, not single updates

6. **Use explicit iteration, not .find()**
   - `.find()` only gets first match
   - Iterate all sides/corners explicitly

---

## Contact

For questions about these fixes:
- Check `schemas/README.md` - Unified Controls section
- Check `docs/architecture/Sidebar_Panels.md` - Full guide
- Review `shared/components/ControlRenderer.js` - Implementation

---

**End of Document**
